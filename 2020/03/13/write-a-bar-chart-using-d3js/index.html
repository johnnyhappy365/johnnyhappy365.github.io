<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 一步一步用 D3js 写一个Bar Chart · Johnny Happy's Blog</title><meta name="description" content="一步一步用 D3js 写一个Bar Chart - Johnny Happy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Johnny Happy's Blog"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Johnny Happy's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/johnnyhappy365" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">一步一步用 D3js 写一个Bar Chart</h1><div class="post-info">Mar 13, 2020</div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文介绍如何使用 d3js 创建一个 bar chart 组件（参考下视频）, 下面操起来！</p>

<video src="/videos/barchart_demo.mov" autoplay loop="loop">
</video>


<h2 id="but-why"><a href="#but-why" class="headerlink" title="but why?"></a>but why?</h2><p>为什么要使用 d3 自己做图表组件呢？现在不是有很多 JS 组件库了吗？</p>
<p>我试着从以下几个原因来说明这个问题：</p>
<ol>
<li>图表库太多不知道选用哪个</li>
<li>有的图表好看，但只支持基本功能，定制能力很差</li>
<li>有的图表要求收费，否则显示图表 logo</li>
<li>费了好多时间找的一个图表库，可是有几个小的交互功能不支持，比如图例不能自定义或不能支持范围选取</li>
</ol>
<h4 id="图表没有“银弹”"><a href="#图表没有“银弹”" class="headerlink" title="图表没有“银弹”"></a>图表没有“银弹”</h4><p>越来越发现“没有银弹”是具有普适性的。<br>包含可视化的项目中，对图表的使用和依赖程度是不一样的。如果一个数据可视化项目要求比较简单，如：只使用了柱图，饼图，拆线图，且只需要图表的展示并不需要图表交互的话。可能世面上的大多数图表都是适用的。但我认为，这类项目不应该算叫数据可视化项目，就是在一个系统中集成了一些简单数据分析的功能。</p>
<p>如果是向天平的另一端看的话，想找到一个能够范围所有项目在数据分析领域的图表库的话，是很难的。一个原因大于这些图表库通过封装而提高了使用的便利性的同时，也损失掉了灵活性。虽然没个图表库都试图开发更多的配置接口，但有时也不如人意。</p>
<h4 id="找一个能够完全满足项目需求的图表库太难"><a href="#找一个能够完全满足项目需求的图表库太难" class="headerlink" title="找一个能够完全满足项目需求的图表库太难"></a>找一个能够完全满足项目需求的图表库太难</h4><p>图表开发的时候会有几个问题经常遇到：</p>
<ol>
<li>可以支持多数据系列</li>
<li>支持时间序列</li>
<li>可以切换数据的可见性，通过图表或图表中的 series</li>
<li>调整图表样式，如设置图表调色板，线条粗细等等</li>
<li>事件的处理，如点击图例，点击数据，范围选取数据</li>
<li>自定义 hover 文本</li>
<li>动画</li>
<li>多 y 轴</li>
<li>数据加载性能</li>
<li>自定义图表</li>
<li>…</li>
</ol>
<p>笔者不定周期的会审查一下市面上的图表库，目前没有得到一个使自己完全满意的。</p>
<h4 id="d3js-定制能力非常强大"><a href="#d3js-定制能力非常强大" class="headerlink" title="d3js 定制能力非常强大"></a>d3js 定制能力非常强大</h4><p>d3js 与其它图表的不同在于它开放给用户的是显示组件，而不是一个个已经封装好的图表。并且每个抽象的显示组件都可以进行编程式的定制。如：Axis, GridLine, Title, Series。从这一点上，d3js 所能做的可能会超越你的想象。我觉得也可以说 d3js 和其它的图表库不是一个使用级别上的东西。所以，也不太好与之相比较。</p>
<h4 id="所以"><a href="#所以" class="headerlink" title="所以"></a>所以</h4><p>我个人建议，如果是一个对数据可视化有一定要求的项目，就直接用 d3js DIY 组件好了，可能提供给你充足的灵活性和想象力。这样不会因为三方库不得不进行功能上的妥协。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><h4 id="工程搭建"><a href="#工程搭建" class="headerlink" title="工程搭建"></a>工程搭建</h4><p>首先，需要搭建最小项目框架，包括：</p>
<ol>
<li><a href="https://webpack.js.org/guides/getting-started/" target="_blank" rel="noopener">配置基础</a></li>
<li><a href="https://webpack.js.org/guides/development/" target="_blank" rel="noopener">配置 webpack-dev-server 和 sourcemap</a></li>
<li><a href="https://webpack.js.org/guides/typescript/" target="_blank" rel="noopener">配置 typescript</a></li>
</ol>
<p>过程参考 webpack 教程就好。</p>
<h4 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h4><p>测试数据使用 faker 进行生成</p>
<p>!!!!<strong>这个地址一会要换成 tag testdata</strong><br><a href="https://github.com/johnnyhappy365/create-chart-using-d3/releases/tag/webpack%2Btypescript" target="_blank" rel="noopener">完整代码</a></p>
<h2 id="显示"><a href="#显示" class="headerlink" title="显示"></a>显示</h2><p>接下来，开始画 Bar Chart 了。</p>
<h4 id="Axis"><a href="#Axis" class="headerlink" title="Axis"></a>Axis</h4><p>我们要画的是一个 horizontal bar chart。所以 Y 轴的对数是 categorial 的，而 X 轴的数据是 number。</p>
<p>X 轴要使用 scaleLinear, 而 Y 轴要使用 scaleBand。</p>
<p>主要代码</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> initAxis() &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; data, width, height, margin &#125; = <span class="keyword">this</span>.config</span><br><span class="line">  <span class="keyword">const</span> maxDomainValue = d3.max(data, <span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> d.x <span class="keyword">as</span> <span class="built_in">number</span>)</span><br><span class="line">  <span class="keyword">this</span>.x = d3</span><br><span class="line">    .scaleLinear()</span><br><span class="line">    .domain([<span class="number">0</span>, maxDomainValue])</span><br><span class="line">    .range([margin.left, width - margin.right])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.xAxis = d3.axisBottom(<span class="keyword">this</span>.x)</span><br><span class="line">  <span class="keyword">this</span>.svg</span><br><span class="line">    .append(<span class="string">'g'</span>)</span><br><span class="line">    .attr(<span class="string">'transform'</span>, <span class="string">`translate(0, <span class="subst">$&#123;height - margin.bottom&#125;</span>)`</span>)</span><br><span class="line">    .call(<span class="keyword">this</span>.xAxis)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.y = d3</span><br><span class="line">    .scaleBand()</span><br><span class="line">    .domain(data.map(<span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> d.y) <span class="keyword">as</span> <span class="built_in">string</span>[])</span><br><span class="line">    .range([margin.top, height - margin.bottom])</span><br><span class="line">    .padding(<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.yAxis = d3.axisLeft(<span class="keyword">this</span>.y)</span><br><span class="line">  <span class="keyword">this</span>.svg</span><br><span class="line">    .append(<span class="string">'g'</span>)</span><br><span class="line">    .attr(<span class="string">'transform'</span>, <span class="string">`translate(<span class="subst">$&#123;margin.left&#125;</span>, 0)`</span>)</span><br><span class="line">    .call(<span class="keyword">this</span>.yAxis)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显示效果如下</p>
<p><img src="/images/barchart__axis.png" alt="d3 barchat axis"></p>
<h4 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h4><p>然后是主角登录，画 Series，当前我们的用例中不包含多 Series 的情况，所以只需要画一个 bar 就行了。</p>
<p>在 SVG 中可以使用 rect 来实现。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> initSeries() &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; data, margin &#125; = <span class="keyword">this</span>.config</span><br><span class="line">  <span class="keyword">this</span>.svg</span><br><span class="line">    .selectAll(<span class="string">'.bar'</span>)</span><br><span class="line">    .data(data)</span><br><span class="line">    .enter()</span><br><span class="line">    .append(<span class="string">'rect'</span>)</span><br><span class="line">    .classed(<span class="string">'bar'</span>, <span class="literal">true</span>)</span><br><span class="line">    .attr(<span class="string">'fill'</span>, Colors.primary)</span><br><span class="line">    .attr(<span class="string">'x'</span>, margin.left)</span><br><span class="line">    .attr(<span class="string">'y'</span>, <span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> <span class="keyword">this</span>.y(d.y))</span><br><span class="line">    .attr(<span class="string">'width'</span>, <span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> <span class="keyword">this</span>.x(d.x) - margin.left)</span><br><span class="line">    .attr(<span class="string">'height'</span>, <span class="keyword">this</span>.y.bandwidth())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>bandwidth()</code> 可以取得 scaleBand 中计算出来的 band 宽度。显示效果如下</p>
<p><img src="/images/barchart__series.png" alt="d3 barchat series"></p>
<h4 id="Grid-Line"><a href="#Grid-Line" class="headerlink" title="Grid Line"></a>Grid Line</h4><p>加网线的方法可以参考这个<a href="http://bl.ocks.org/35degrees/23873a64ceec2390c400694b6a8b57d9" target="_blank" rel="noopener">例子</a></p>
<p>grid line 实际上就是一个 axis。在些基础上需要注意几点：</p>
<ol>
<li>tickFormat 设置成’’</li>
<li>设置 ticks(interval)</li>
<li>设置下样式</li>
<li>在 series 和 axis 的图层下方进行绘制</li>
<li>x/y 轴是否都需要加 grid line 适具体情况而定</li>
</ol>
<p>主要代码参考如下</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> initGridlines() &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; height, margin &#125; = <span class="keyword">this</span>.config</span><br><span class="line">  <span class="keyword">const</span> gridX = d3</span><br><span class="line">    .axisBottom(<span class="keyword">this</span>.x)</span><br><span class="line">    .ticks(<span class="number">5</span>)</span><br><span class="line">    .tickSize(-height + margin.top + margin.bottom)</span><br><span class="line">    .tickFormat(<span class="function"><span class="params">()</span> =&gt;</span> <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">this</span>.svg</span><br><span class="line">    .append(<span class="string">'g'</span>)</span><br><span class="line">    .call(gridX)</span><br><span class="line">    .classed(<span class="string">'grid'</span>, <span class="literal">true</span>)</span><br><span class="line">    .attr(<span class="string">'color'</span>, Colors.grey)</span><br><span class="line">    .attr(<span class="string">'stroke-width'</span>, <span class="number">0.1</span>)</span><br><span class="line">    .attr(<span class="string">'stroke-dasharray'</span>, <span class="string">'3,3'</span>)</span><br><span class="line">    .attr(<span class="string">'transform'</span>, <span class="string">`translate(0, <span class="subst">$&#123;height - margin.bottom&#125;</span>)`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/barchart__gridline.png" alt="d3 bar chart with gridline"></p>
<h4 id="Mid-Line"><a href="#Mid-Line" class="headerlink" title="Mid Line"></a>Mid Line</h4><p>通过上面的努力已经完成了一个静态 bar chart。如果不需要任何交互的话，这个图表已经是可以在项目中使用的了。</p>
<p>有时，为了提供数据分析的效率，会在些基础上绘制一些辅助线，比如：中位数线。</p>
<p>中线主要有几个点注意下就可以了:</p>
<ol>
<li>使用<code>d3.median()</code>计算中位数，d3 也提供了其它基础的统计方法，如四分位数和平均数等</li>
<li>在 svg 画一个 line, 显示中位数线</li>
<li>在 svg 画一个 text, 显示数值</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> initMidLine() &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; data, margin, height &#125; = <span class="keyword">this</span>.config</span><br><span class="line">  <span class="keyword">const</span> midValue = d3.median(data.map(<span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> d.x <span class="keyword">as</span> <span class="built_in">number</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.svg</span><br><span class="line">    .append(<span class="string">'line'</span>)</span><br><span class="line">    .classed(<span class="string">'mid'</span>, <span class="literal">true</span>)</span><br><span class="line">    .attr(<span class="string">'stroke'</span>, Colors.secondary)</span><br><span class="line">    .attr(<span class="string">'stroke-width'</span>, <span class="number">2</span>)</span><br><span class="line">    .attr(<span class="string">'x1'</span>, <span class="keyword">this</span>.x(midValue))</span><br><span class="line">    .attr(<span class="string">'x2'</span>, <span class="keyword">this</span>.x(midValue))</span><br><span class="line">    .attr(<span class="string">'y1'</span>, margin.top)</span><br><span class="line">    .attr(<span class="string">'y2'</span>, height - margin.bottom)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add text</span></span><br><span class="line">  <span class="keyword">this</span>.svg</span><br><span class="line">    .append(<span class="string">'text'</span>)</span><br><span class="line">    .classed(<span class="string">'mid-text'</span>, <span class="literal">true</span>)</span><br><span class="line">    .attr(<span class="string">'x'</span>, <span class="keyword">this</span>.x(midValue) + <span class="number">2</span>)</span><br><span class="line">    .attr(<span class="string">'y'</span>, margin.top)</span><br><span class="line">    .attr(<span class="string">'width'</span>, <span class="number">20</span>)</span><br><span class="line">    .attr(<span class="string">'height'</span>, <span class="number">10</span>)</span><br><span class="line">    .attr(<span class="string">'font-size'</span>, <span class="string">'10px'</span>)</span><br><span class="line">    .attr(<span class="string">'font-family'</span>, <span class="string">'sans-serif'</span>)</span><br><span class="line">    .style(<span class="string">'fill'</span>, Colors.secondary)</span><br><span class="line">    .text(<span class="string">`mid: <span class="subst">$&#123;midValue&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/barchart__mid.png" alt="d3 bar chart with mid value"></p>
<h4 id="Responsive"><a href="#Responsive" class="headerlink" title="Responsive"></a>Responsive</h4><p>有一个隐性需求是图表经常要自适应屏幕的大小。svg 可能通过以下代码实现在 block 容器中自适应大小，并且可以根据屏幕尺寸的改变而自动按比例进行缩放。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> initSvg() &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; selector, width, height &#125; = <span class="keyword">this</span>.config</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.svg = d3</span><br><span class="line">    .select(selector)</span><br><span class="line">    .append(<span class="string">'div'</span>)</span><br><span class="line">    .classed(<span class="string">'chart-wrapper'</span>, <span class="literal">true</span>)</span><br><span class="line">    .style(<span class="string">'display'</span>, <span class="string">'inline-block'</span>)</span><br><span class="line">    .style(<span class="string">'position'</span>, <span class="string">'relative'</span>)</span><br><span class="line">    .style(<span class="string">'width'</span>, <span class="string">'100%'</span>)</span><br><span class="line">    .style(<span class="string">'padding-bottom'</span>, <span class="string">'100%'</span>)</span><br><span class="line">    .style(<span class="string">'vertical-align'</span>, <span class="string">'top'</span>)</span><br><span class="line">    .style(<span class="string">'overflow'</span>, <span class="string">'hidden'</span>)</span><br><span class="line">    <span class="comment">// Container class to make it responsive.</span></span><br><span class="line">    .append(<span class="string">'svg'</span>)</span><br><span class="line">    .attr(<span class="string">'preserveAspectRatio'</span>, <span class="string">'xMinYMin meet'</span>)</span><br><span class="line">    .attr(<span class="string">'viewBox'</span>, <span class="string">`0 0 <span class="subst">$&#123;width&#125;</span> <span class="subst">$&#123;height&#125;</span>`</span>)</span><br><span class="line">    .style(<span class="string">'display'</span>, <span class="string">'inline-block'</span>)</span><br><span class="line">    .style(<span class="string">'position'</span>, <span class="string">'absolute'</span>)</span><br><span class="line">    .style(<span class="string">'top'</span>, <span class="string">'0'</span>)</span><br><span class="line">    .style(<span class="string">'left'</span>, <span class="string">'0'</span>)</span><br><span class="line">  <span class="comment">// .style('background-color', Colors.grey)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="交互"><a href="#交互" class="headerlink" title="交互"></a>交互</h2><p>通过 d3js 可以很方便的实现想要的交互功能。在这里我们实现最常用的几个 bar chart 的交互：</p>
<ol>
<li>鼠标悬停在数据上进行高亮，并显示 tooltip 数值</li>
<li>点击事件</li>
</ol>
<p>使用<code>on</code>进行事件监听，<code>click</code> 事件用来响应点击。hover 的处理包含进入和退出需要监听 <code>mouseover</code> 和 <code>mouseout</code>。另外，hover 的处理要加上 animation，不然的话状态切换会有些生硬。修改后的<code>initSeries</code>如下</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> initSeries() &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; data, margin &#125; = <span class="keyword">this</span>.config</span><br><span class="line">  <span class="keyword">const</span> that = <span class="keyword">this</span></span><br><span class="line">  <span class="keyword">this</span>.series = <span class="keyword">this</span>.svg</span><br><span class="line">    .selectAll(<span class="string">'.bar'</span>)</span><br><span class="line">    .data(data)</span><br><span class="line">    .enter()</span><br><span class="line">    .append(<span class="string">'rect'</span>)</span><br><span class="line">    .classed(<span class="string">'bar'</span>, <span class="literal">true</span>)</span><br><span class="line">    .attr(<span class="string">'fill'</span>, Colors.primary)</span><br><span class="line">    .attr(<span class="string">'x'</span>, margin.left + <span class="number">1</span>) <span class="comment">// forbiden overlay by series</span></span><br><span class="line">    .attr(<span class="string">'y'</span>, <span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> <span class="keyword">this</span>.y(d.y))</span><br><span class="line">    .attr(<span class="string">'width'</span>, <span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> <span class="keyword">this</span>.x(d.x) - margin.left)</span><br><span class="line">    .attr(<span class="string">'height'</span>, <span class="keyword">this</span>.y.bandwidth())</span><br><span class="line">    .on(<span class="string">'click'</span>, <span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> alert(<span class="string">`click <span class="subst">$&#123;d.y&#125;</span>`</span>))</span><br><span class="line">    .on(<span class="string">'mouseover.bar'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d: DataItem, i: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">      that.setSeriesColor(Colors.grey)</span><br><span class="line">      d3.select(<span class="keyword">this</span>)</span><br><span class="line">        .transition()</span><br><span class="line">        .duration(<span class="number">200</span>)</span><br><span class="line">        .attr(<span class="string">'fill'</span>, Colors.primary)</span><br><span class="line"></span><br><span class="line">      that.seriesLabel</span><br><span class="line">        .filter(<span class="function">(<span class="params">d: DataItem, index: <span class="built_in">number</span></span>) =&gt;</span> index === i)</span><br><span class="line">        .transition()</span><br><span class="line">        .duration(<span class="number">200</span>)</span><br><span class="line">        .attr(<span class="string">'opacity'</span>, <span class="number">0.9</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .on(<span class="string">'mouseout.bar'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d: DataItem, i: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">      that.setSeriesColor(Colors.primary)</span><br><span class="line">      that.seriesLabel</span><br><span class="line">        .transition()</span><br><span class="line">        .duration(<span class="number">200</span>)</span><br><span class="line">        .attr(<span class="string">'opacity'</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.seriesLabel = <span class="keyword">this</span>.svg</span><br><span class="line">    .selectAll(<span class="string">'.series-label'</span>)</span><br><span class="line">    .data(data)</span><br><span class="line">    .enter()</span><br><span class="line">    .append(<span class="string">'text'</span>)</span><br><span class="line">    .classed(<span class="string">'series-label'</span>, <span class="literal">true</span>)</span><br><span class="line">    .text(<span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> d.x)</span><br><span class="line">    .attr(<span class="string">'fill'</span>, Colors.text)</span><br><span class="line">    .attr(<span class="string">'x'</span>, <span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> <span class="keyword">this</span>.x(d.x) + <span class="number">4</span>) <span class="comment">// forbiden overlay by series</span></span><br><span class="line">    .attr(<span class="string">'y'</span>, <span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> <span class="keyword">this</span>.y(d.y) + <span class="keyword">this</span>.y.bandwidth() / <span class="number">2</span>)</span><br><span class="line">    .attr(<span class="string">'width'</span>, <span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> <span class="keyword">this</span>.x(d.x) - margin.left)</span><br><span class="line">    .attr(<span class="string">'dominant-baseline'</span>, <span class="string">'central'</span>)</span><br><span class="line">    .attr(<span class="string">'height'</span>, <span class="keyword">this</span>.y.bandwidth())</span><br><span class="line">    .attr(<span class="string">'font-size'</span>, <span class="string">'8px'</span>)</span><br><span class="line">    .attr(<span class="string">'font-family'</span>, <span class="string">'sans-serif'</span>)</span><br><span class="line">    .attr(<span class="string">'opacity'</span>, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/barchart__hover.png" alt="d3 bar chart with highlight"></p>
<h2 id="组件化"><a href="#组件化" class="headerlink" title="组件化"></a>组件化</h2><p>最好一步，把一些可重用的配置抽取出来，一个图表组件就可能在项目中使用了。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> BarChart(&#123;</span><br><span class="line">  selector: <span class="string">'#chart-1'</span>,</span><br><span class="line">  data: testdata.data1(),</span><br><span class="line">  showMidLine: <span class="literal">false</span>,</span><br><span class="line">  margin: &#123;</span><br><span class="line">    bottom: <span class="number">20</span>,</span><br><span class="line">    left: <span class="number">200</span>,</span><br><span class="line">    top: <span class="number">20</span>,</span><br><span class="line">    right: <span class="number">20</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onClick: <span class="function"><span class="params">d</span> =&gt;</span> &#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2020/03/14/write-a-line-chart-using-d3/" class="prev">PREV</a><a href="/2020/03/02/material-design-motion-pattern/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 - 2020 <a href="http://yoursite.com">Johnny Happy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>