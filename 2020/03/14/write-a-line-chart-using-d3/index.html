<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 一步一步用 D3js 写一个 Line Chart · Johnny Happy's Blog</title><meta name="description" content="一步一步用 D3js 写一个 Line Chart - Johnny Happy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Johnny Happy's Blog"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Johnny Happy's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/johnnyhappy365" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">一步一步用 D3js 写一个 Line Chart</h1><div class="post-info">Mar 14, 2020</div><div class="post-content"><p><a href="write-a-bar-chart-using-d3js.md">上文</a>介绍了如何用 D3js 写一个 bar chart。本文继承上文的知识点，并加以补充描述如何画一个基于时间序列为 Line Chart。</p>

<video src="/videos/linechart_demo.mov" autoplay loop="loop">
</video>


<p>时间序列通常有几个常见的特点:</p>
<ol>
<li>x 轴为时间，可能是不同的时间粒度。</li>
<li>x 轴要注意格式的显示，由于时间字符串长度较大，可能要考虑巧妙的设计 ticks 和 tickFormat。</li>
<li>有时会用到动态实时刷新的处理</li>
<li>通过范围选定一个时间范围，然后进行钻取(drill down)</li>
<li>金融领域也使用时间序列，但在此基础上加了很多技术分析相关的显示组件。</li>
</ol>
<p>以下介绍一个所有领域通用的 Line Chart.</p>
<h2 id="step-by-step"><a href="#step-by-step" class="headerlink" title="step by step"></a>step by step</h2><h4 id="Axis"><a href="#Axis" class="headerlink" title="Axis"></a>Axis</h4><p> 首先先画轴。Y 轴使用的是<code>sacleLinear</code>。X 轴这里是时间序列所以要使用<code>scaleTime</code>。<code>scaleTime</code> 在缩放的时候是使用 Date 对象绽放成数值，这点需要注意。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.x = d3</span><br><span class="line">  .scaleTime()</span><br><span class="line">  .domain([data[<span class="number">0</span>].x <span class="keyword">as</span> <span class="built_in">Date</span>, data[data.length - <span class="number">1</span>].x <span class="keyword">as</span> <span class="built_in">Date</span>])</span><br><span class="line">  .range([margin.left, width - margin.right])</span><br></pre></td></tr></table></figure>

<p>轴的 tick 间隔也可以基于时间进行设置</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.xAxis = d3</span><br><span class="line">  .axisBottom(<span class="keyword">this</span>.x)</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  .tickFormat(<span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> moment(d).format(<span class="string">'M-D'</span>))</span><br><span class="line">  .ticks(d3.timeDay.every(<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<p>下面是显示效果：<br><img src="/images/linechart__axis.png" alt="d3 line chart axis"></p>
<h4 id="Series-amp-Tooltip"><a href="#Series-amp-Tooltip" class="headerlink" title="Series &amp; Tooltip"></a>Series &amp; Tooltip</h4><p>画 series 时要注意，拆线图是在 svg 上是一个 line，这样就不能直接响应某个数据点的 hover 事件。所以需要在线上再加一组点，然后将 hover 的处理作用在点上。当然这个点可以设置成可见与不可见的。对于不可见的情况感觉是 hover 上线上了，实际是透明的点响应了这个事件。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">initSeries() &#123;</span><br><span class="line">   <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">this</span>.config</span><br><span class="line">   <span class="keyword">const</span> that = <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">const</span> line = d3</span><br><span class="line">     .line()</span><br><span class="line">     .x(<span class="function">(<span class="params">d: <span class="built_in">any</span>, i: <span class="built_in">number</span></span>) =&gt;</span> that.x(d.x))</span><br><span class="line">     .y(<span class="function">(<span class="params">d: <span class="built_in">any</span>, i: <span class="built_in">number</span></span>) =&gt;</span> that.y(d.y))</span><br><span class="line">     .curve(d3.curveMonotoneX)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.series = <span class="keyword">this</span>.svg</span><br><span class="line">     .append(<span class="string">'path'</span>)</span><br><span class="line">     .datum(data) <span class="comment">// 10. Binds data to the line</span></span><br><span class="line">     .attr(<span class="string">'class'</span>, <span class="string">'line'</span>) <span class="comment">// Assign a class for styling</span></span><br><span class="line">     .attr(<span class="string">'d'</span>, line)</span><br><span class="line">     .attr(<span class="string">'fill'</span>, <span class="string">'none'</span>)</span><br><span class="line">     .attr(<span class="string">'stroke'</span>, Colors.primary)</span><br><span class="line">     .attr(<span class="string">'stroke-width'</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">const</span> dot = <span class="keyword">this</span>.svg</span><br><span class="line">     .selectAll(<span class="string">'.dot'</span>)</span><br><span class="line">     .data(data)</span><br><span class="line">     .enter()</span><br><span class="line">     .append(<span class="string">'circle'</span>) <span class="comment">// Uses the enter().append() method</span></span><br><span class="line">     .attr(<span class="string">'class'</span>, <span class="string">'dot'</span>) <span class="comment">// Assign a class for styling</span></span><br><span class="line">     .attr(<span class="string">'cx'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> that.x(moment(d.x).toDate())</span><br><span class="line">     &#125;)</span><br><span class="line">     .attr(<span class="string">'cy'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> that.y(d.y)</span><br><span class="line">     &#125;)</span><br><span class="line">     .attr(<span class="string">'r'</span>, <span class="number">5</span>)</span><br><span class="line">     .attr(<span class="string">'fill'</span>, Colors.primary)</span><br><span class="line">     .attr(<span class="string">'stroke'</span>, <span class="string">'#fff'</span>)</span><br><span class="line">     .style(<span class="string">'cursor'</span>, <span class="string">'pointer'</span>)</span><br><span class="line">     .attr(<span class="string">'stroke-width'</span>, <span class="number">2</span>)</span><br><span class="line">     .on(<span class="string">'mouseover'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d: DataItem, i: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">'y'</span>, that.y(d.y))</span><br><span class="line">       that.tooltip</span><br><span class="line">         .transition()</span><br><span class="line">         .duration(<span class="number">20</span>)</span><br><span class="line">         .style(<span class="string">'opacity'</span>, <span class="number">0.9</span>)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">let</span> left = d3.event.pageX + <span class="number">20</span></span><br><span class="line">       <span class="keyword">if</span> (i &gt; data.length / <span class="number">2</span>) &#123;</span><br><span class="line">         left = d3.event.pageX - <span class="number">120</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">const</span> maxDomainValue = d3.max(data, <span class="function">(<span class="params">d: DataItem</span>) =&gt;</span> d.y <span class="keyword">as</span> <span class="built_in">number</span>)</span><br><span class="line">       <span class="keyword">let</span> top = d3.event.pageY - <span class="number">60</span></span><br><span class="line">       <span class="keyword">if</span> (d.y &gt; maxDomainValue * <span class="number">0.66</span>) &#123;</span><br><span class="line">         top = d3.event.pageY + <span class="number">20</span></span><br><span class="line">       &#125;</span><br><span class="line">       that.tooltip</span><br><span class="line">         .html(moment(d.x).format(<span class="string">'YYYY-MM-DD'</span>) + <span class="string">'&lt;br /&gt;'</span> + d.y)</span><br><span class="line">         .style(<span class="string">'left'</span>, left + <span class="string">'px'</span>)</span><br><span class="line">         .style(<span class="string">'top'</span>, top + <span class="string">'px'</span>)</span><br><span class="line">         .style(<span class="string">'z-index'</span>, <span class="number">1</span>)</span><br><span class="line">     &#125;)</span><br><span class="line">     .on(<span class="string">'mouseout'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d: DataItem, i: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">       that.tooltip.style(<span class="string">'opacity'</span>, <span class="number">0</span>).style(<span class="string">'z-index'</span>, <span class="number">-1</span>)</span><br><span class="line">     &#125;)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>下面是显示效果：<br><img src="/images/linechart__series.png" alt="d3 line chart series"></p>
<h4 id="gridline"><a href="#gridline" class="headerlink" title="gridline"></a>gridline</h4><p>实现网格线的方式与<a href="write-a-bar-chart-using-d3js.md">上文</a>一致，不再赘述。</p>
<h2 id="交互"><a href="#交互" class="headerlink" title="交互"></a>交互</h2><h4 id="实现范围选取"><a href="#实现范围选取" class="headerlink" title="实现范围选取"></a>实现范围选取</h4><p>d3js 可以实现一个方向或两个方向的 brush 来进行范围选取。在范围选取后可以通过<code>d3.brushSelection(this)</code>来获得选区.</p>
<p>有几点要注意：</p>
<ol>
<li>brush 层要放在 series 下，否则会出现 tooltip 不生效的现象。原来是 brush 占用了一个图层来实现 draging 的处理。有点像手机屏幕的原理，有显示层，有触摸层，有防护层。</li>
<li>通过<code>brush.extent()</code>限制选区的范围，这里需要把 margin 去掉</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> initBrush() &#123;</span><br><span class="line">    <span class="keyword">const</span> that = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">const</span> &#123; margin, width, height &#125; = <span class="keyword">this</span>.config</span><br><span class="line">    <span class="keyword">const</span> brushX = d3.brushX().extent([</span><br><span class="line">      [margin.left, margin.top],</span><br><span class="line">      [width - margin.right, height - margin.bottom]</span><br><span class="line">    ])</span><br><span class="line">    brushX</span><br><span class="line">      <span class="comment">// .on('start') // brush start event</span></span><br><span class="line">      .on(<span class="string">'brush'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> ext: <span class="built_in">any</span>[] = d3.brushSelection(<span class="keyword">this</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">          <span class="string">'brushing'</span>,</span><br><span class="line">          ext.map(<span class="function">(<span class="params">e: <span class="built_in">any</span></span>) =&gt;</span> that.x.invert(e))</span><br><span class="line">        )</span><br><span class="line">      &#125;)</span><br><span class="line">      .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> ext: <span class="built_in">any</span>[] = d3.brushSelection(<span class="keyword">this</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">          <span class="string">'brush end'</span>,</span><br><span class="line">          ext.map(<span class="function">(<span class="params">e: <span class="built_in">any</span></span>) =&gt;</span> that.x.invert(e))</span><br><span class="line">        )</span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="keyword">this</span>.svg</span><br><span class="line">      .append(<span class="string">'g'</span>)</span><br><span class="line">      .attr(<span class="string">'class'</span>, <span class="string">'brush'</span>)</span><br><span class="line">      .call(brushX)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>效果如下<br><img src="/images/linechart__brush.png" alt=""></p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/03/14/amazing-life-note-1/" class="prev">PREV</a><a href="/2020/03/13/write-a-bar-chart-using-d3js/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 - 2020 <a href="http://yoursite.com">Johnny Happy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>